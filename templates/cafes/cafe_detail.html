{% extends "base.html" %}

{% block title %}{{ cafe.name }} — Гид по кофейням{% endblock %}

{% block content %}
  <section class="cafe-hero">
    {% if cafe.main_image %}
      <figure class="cafe-hero__image-wrapper">
        <img
          src="{{ cafe.main_image.url }}"
          alt="{{ cafe.name }}"
          class="cafe-hero__image"
        >
      </figure>
    {% endif %}

    <div class="cafe-hero__info">
      <h1 class="cafe-hero__title">{{ cafe.name }}</h1>
      {% if cafe.tagline %}
        <p class="cafe-hero__tagline">{{ cafe.tagline }}</p>
      {% endif %}

      <p class="cafe-hero__meta">
        {{ cafe.city }}, {{ cafe.address }}
        {% if cafe.area %} • район: {{ cafe.area }}{% endif %}
      </p>

      <p class="cafe-hero__meta">
        Цена: {{ cafe.get_price_level_display }}
        {% if cafe.rating %} • рейтинг: {{ cafe.rating }}★{% endif %}
      </p>

      {% if user.is_authenticated %}
        <form
          method="post"
          action="{% url 'cafes:toggle_favorite' cafe.slug %}"
        >
          {% csrf_token %}
          <button type="submit" class="nav-button">
            {% if is_favorite %}
              Убрать из избранного
            {% else %}
              В избранное
            {% endif %}
          </button>
        </form>
      {% else %}
        <p class="cafe-hero__meta">
          <a href="{% url 'login' %}?next={{ request.path }}">Войдите</a>,
          чтобы добавить в избранное.
        </p>
      {% endif %}
    </div>
  </section>

  {% if cafe.description %}
    <section class="section">
      <h2 class="section__title">О кофейне</h2>
      <p>{{ cafe.description|linebreaksbr }}</p>
    </section>
  {% endif %}

  <section class="section">
    <h2 class="section__title">Отзывы</h2>

    {% if reviews %}
      <ul class="review-list">
        {% for review in reviews %}
          <li class="review-list__item">
            <p class="review-list__meta">
              {{ review.user.username }}
              • {{ review.created_at|date:"d.m.Y" }}
              • {{ review.rating }}★
            </p>
            <p class="review-list__text">{{ review.text }}</p>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p>Пока нет отзывов. Будьте первым, кто оставит отзыв.</p>
    {% endif %}

    {% if user.is_authenticated %}
      <form method="post">
        {% csrf_token %}
        {{ form.non_field_errors }}

        <div>
          <label for="{{ form.rating.id_for_label }}">Оценка (1–5)</label>
          {{ form.rating }}
          {{ form.rating.errors }}
        </div>

        <div>
          <label for="{{ form.text.id_for_label }}">Отзыв</label>
          {{ form.text }}
          {{ form.text.errors }}
        </div>

        <button type="submit" class="nav-button nav-button--primary">
          Оставить отзыв
        </button>
      </form>
    {% else %}
      <p>
        Чтобы написать отзыв,
        <a href="{% url 'login' %}?next={{ request.path }}">войдите</a>
        или
        <a href="{% url 'cafes:signup' %}?next={{ request.path }}">зарегистрируйтесь</a>.
      </p>
    {% endif %}
  </section>
{% endblock %}
